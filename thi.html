<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="./style.css" />
    <script src="./script.js"></script>
    <script>
      if (!localStorage.getItem("user")) {
        alert("Bạn cần đăng nhập để vào thi !!");
        location.href = "./index.html";
      }
    </script>
    <title>Thi trực tuyến</title>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg border-bottom">
      <div class="container justify-content-between">
        <button
          class="navbar-brand border-0 bg-transparent"
          onclick="javascript:window.location.href=window.location.href"
        >
          <img src="./logo.png" width="60px" alt="Logo" />
        </button>
        <div class="fw-semibold">HỆ THỐNG THI TRỰC TUYẾN</div>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-end">
            <li class="nav-item">
              <a class="nav-link" aria-current="page" href="./">Trang chủ</a>
            </li>
            <li class="nav-item">
              <span class="nav-link active" aria-current="page">Nội quy</span>
            </li>
            <li class="nav-item">
              <span class="nav-link logout" href="./logout.html"
                >Chào
                <span class="fw-semibold"
                  ><script>
                    document.write(localStorage.getItem("user"));
                  </script></span
                >
                [Đăng xuất]</span
              >
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <main class="baithi container">
      <section class="baithi-noiquy col-12 col-md-10 col-lg-10 mx-auto mt-3">
        <div class="card my-3">
          <div class="card-header">Làm bài thi</div>
          <div class="card-body">
            <p class="card-text">
              - Bài thi được tính ngay sau khi ấn nút Bắt đầu
            </p>
            <p class="card-text">
              - Thí sinh có tổng thời gian 1 phút để trả lời 10 câu hỏi
            </p>
            <p class="card-text">
              - Không được thoát ra hoặc load lại trang khi làm bài
            </p>
            <p class="card-text">
              - Bài thi sẽ không được tính nếu thoát giữa chừng
            </p>
            <p class="card-text">
              - Sau khi hết thời gian, kết quả sẽ vẫn được tính dựa trên các đáp
              án đã tích hợp lệ
            </p>
            <p class="card-text">
              - Thí sinh lưu ý quan sát màn hình (máy tính) để biết số câu hỏi
              đã trả lời, tránh việc làm sót câu.
            </p>
            <button type="button" class="btn btn-primary batdau">
              Bắt đầu bài thi
            </button>
          </div>
        </div>
      </section>
      <section class="lambai row mt-3 col-12 col-lg-7 col-md-9 mx-auto d-none">
        <div class="col-12 col-sm-9">
          <div class="card">
            <div class="card-header">
              Làm bài thi
            </div>
            <div class="card-body ps-4"></div>
          </div>
        </div>
        <div
          class="mt-3 col-12 col-sm-3 d-flex flex-column justify-content-center"
        >
          <div class="btn btn-danger mb-3 time">02:00</div>
          <button
            type="button"
            class="d-none d-sm-block btn btn-primary mb-2 bt1"
          >
            1. <span class="fw-3"></span>
          </button>
          <button
            type="button"
            class="d-none d-sm-block btn btn-primary mb-2 bt2"
          >
            2: <span class="fw-3"></span>
          </button>
          <button
            type="button"
            class="d-none d-sm-block btn btn-primary mb-3 bt3"
          >
            3: <span class="fw-3"></span>
          </button>
          <button
            type="button"
            class="d-none d-sm-block btn btn-primary mb-2 bt4"
          >
            4. <span class="fw-3"></span>
          </button>
          <button
            type="button"
            class="d-none d-sm-block btn btn-primary mb-2 bt5"
          >
            5: <span class="fw-3"></span>
          </button>
          <button
            type="button"
            class="d-none d-sm-block btn btn-primary mb-2 bt6"
          >
            6: <span class="fw-3"></span>
          </button>
          <button
            type="button"
            class="d-none d-sm-block btn btn-primary mb-2 bt7"
          >
            7. <span class="fw-3"></span>
          </button>
          <button
            type="button"
            class="d-none d-sm-block btn btn-primary mb-2 bt8"
          >
            8: <span class="fw-3"></span>
          </button>
          <button
            type="button"
            class="d-none d-sm-block btn btn-primary mb-2 bt9"
          >
            9: <span class="fw-3"></span>
          </button>
          <button
            type="button"
            class="d-none d-sm-block btn btn-primary mb-2 bt10"
          >
            10: <span class="fw-3"></span>
          </button>
          <button type="button" class="btn btn-success nopbai mb-2">
            Nộp bài
          </button>
        </div>
      </section>
    </main>
    <div class="ketqua">
      <div id="myModal" class="modal">
        <div class="modal-content">
          <div class="modal-header bg-info">
            <strong class="mx-auto">Thông báo</strong>
            <span class="close">&times;</span>
          </div>
          <div class="modal-body">
            <p></p>
          </div>
        </div>
      </div>
    </div>

    <script>
      let qaAPI = "./qa.json"; //file json câu hỏi
      let soCauhoi = 20; // Số câu hỏi trong 1 đề
      let dethi = ""; // String mã đề thi
      let renderCauhoi = ""; // Html -> render ra dữ liệu cấu hỏi

      let modal = document.getElementById("myModal");
      let modalContent = document.getElementsByClassName("modal-content")[0];
      let modalBody = document.getElementsByClassName("modal-body")[0];
      let closeBtn = document.getElementsByClassName("close")[0];
      if (closeBtn) {
        closeBtn.onclick = function () {
          modal.style.display = "none";
        };
      }

      // rút gọn cú pháp gọi element
      let $ = (query) => document.querySelector(query);

      let logOut = document.getElementsByClassName("logout")[0];
      logOut.onclick = () => {
        let confirmAction = confirm("Bạn có chắc chắn muốn đăng xuất");
        if (confirmAction) {
          window.onbeforeunload = null;
          location.href = "./logout.html";
        } else {
        }
      };
      let s;
      fetch(qaAPI)
        .then((respond) => respond.json())
        .then((cauhoi) => {
          let getDapAn = []; // Mảng chứa đáp án

          // tạo mảng theo thứ tự từ 0 đến (số câu hỏi - 1) . Mục đích để khi lấy 1 đề, số thứ tự câu hiện tại sẽ loại khỏi mảng, tránh trường hợp trùng câu hỏi khi render
          let arrRand = Array.from(Array(cauhoi.length).keys());
          for (let i = 0; i < soCauhoi; i++) {
            let randNum = Math.floor(Math.random() * arrRand.length);
            let rands = arrRand[randNum];
            dethi += randNum;
            arrRand.splice(randNum - 1, 1); // loại phần tử ra khỏi mảng số thứ tự
            getDapAn.push(cauhoi[rands].as);
            renderCauhoi += `
                <div class="cauhoi">
                    <div class="debai debai-${i + 1} mt-2 mb-1">${i + 1}. ${
              cauhoi[rands].qs
            }</div>
                    <div class="form-check dapan">
                        <input class="form-check-input" type="radio" name="dapan-${
                          i + 1
                        }"
                        id="dapan-a${i + 1}" dapan="A" value="${
              cauhoi[rands].da
            }">
                        <label class="form-check-label" for="dapan-a${i + 1}">
                            <span class="lb-dapan">A</span> ${cauhoi[rands].da}
                        </label>
                    </div>
                    <div class="form-check dapan">
                        <input class="form-check-input" type="radio" name="dapan-${
                          i + 1
                        }"
                        id="dapan-b${i + 1}" dapan="B" value="${
              cauhoi[rands].db
            }">
                        <label class="form-check-label" for="dapan-b${i + 1}">
                            <span class="lb-dapan">B</span> ${cauhoi[rands].db}
                        </label>
                    </div>
                    <div class="form-check dapan">
                        <input class="form-check-input" type="radio" name="dapan-${
                          i + 1
                        }"
                        id="dapan-c${i + 1}" dapan="C" value="${
              cauhoi[rands].dc
            }">
                        <label class="form-check-label" for="dapan-c${i + 1}">
                            <span class="lb-dapan">C</span> ${cauhoi[rands].dc}
                        </label>
                    </div>
                    <div class="form-check dapan">
                        <input class="form-check-input" type="radio" name="dapan-${
                          i + 1
                        }"
                        id="dapan-d${i + 1}" dapan="D" value="${
              cauhoi[rands].dd
            }">
                        <label class="form-check-label" for="dapan-d${i + 1}">
                            <span class="lb-dapan">D</span> ${cauhoi[rands].dd}
                        </label>
                    </div>
                </div>
                `;
          }
          return getDapAn;
        })
        .then((data) => {
          let listDapAn = []; // danh sách đáp án của thí sinh
          let soDung = 0; // số đáp án đúng
          function cham() {
            let getDapAnS = document.querySelectorAll(
              "input[type=radio]:checked"
            );
            for (let giatri of getDapAnS) {
              listDapAn.push(giatri.value);
            }
            data.forEach((dung, stt) => {
              if (dung === listDapAn[stt]) {
                soDung++;
              }
            });
          }
          document.getElementsByClassName("batdau")[0].onclick = () => {
            window.onbeforeunload = () => ""; // Cảnh báo dữ liệu bị thay đổi khi cố tình load trang
            $("section.baithi-noiquy").classList.add("d-none");
            $("span.dethi").textContent = parseInt(dethi); // in ra mã đề thi
            document
              .getElementsByClassName("lambai")[0]
              .classList.remove("d-none");
            $(".lambai .card-body").innerHTML = renderCauhoi; // render câu hỏi
            let dapan = document.querySelectorAll("input[type=radio]");
            function startTimer(duration, display) {
              var timer = duration,
                minutes,
                seconds;
              s = setInterval(function () {
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);

                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;

                display.textContent = minutes + ":" + seconds;
                if (--timer < 0) {
                  clearInterval(s);
                  window.onbeforeunload = null; // Hủy trạng thái chặn thoát trang.
                  cham(); //chấm điểm
                  modalBody.innerHTML =
                    "<p>Hết thời gian. Hệ thống sẽ chấm điểm với các câu đã hoàn thành</p>";
                  modal.style.display = "block";
                  setTimeout(() => {
                    modalBody.innerHTML += `<strong>${soDung}/3 câu đúng,
                            ${(soDung * 3.33).toFixed(0)} điểm về chỗ</strong>`;
                    modal.style.display = "block";
                  }, 3000);

                  setTimeout(() => {
                    window.location.reload(true);
                  }, 8000);
                }
              }, 1000);
            }

            var fiveMinutes = 12 * 5 - 1,
              display = $(".time");
            startTimer(fiveMinutes, display); // render thời gian làm bài đếm ngược

            dapan.forEach((e, index) => {
              e.onclick = function () {
                $(`.debai-${Math.floor(index / 4) + 1} span`).textContent =
                  this.value;
                // số thứ tự chia 4 để tính đáp án hiện tại thuộc câu hỏi mấy. Sau đó gán text này vào dấu ... của câu hỏi

                $(`.bt${Math.floor(index / 4) + 1} span`).textContent =
                  this.getAttribute("dapan"); // lấy attribute chứa A,B,C,D tương ứng của đáp án
              };
            });
          };

          document.getElementsByClassName("nopbai")[0].onclick = () => {
            let confirmAction = confirm("Bạn có chắc chắn muốn nộp bài?");
            if (confirmAction) {
              clearInterval(s);
              window.onbeforeunload = null;
              cham();
              modalBody.innerHTML =
                "<p>Hệ thống đang chấm điểm tự động ...</p>";
              modal.style.display = "block";
              setTimeout(() => {
                modalBody.innerHTML += `<strong>${soDung}/10 câu đúng,
                    ${(soDung * 1).toFixed(0)} điểm về chỗ</strong>`; // công thức điểm làm tròn
                modal.style.display = "block";
              }, 3000);

              setTimeout(() => {
                window.location.reload(true);
              }, 8000);
            } else {
            }
          };
        });
    </script>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
